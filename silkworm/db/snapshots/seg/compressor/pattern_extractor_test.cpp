/*
   Copyright 2024 The Silkworm Authors

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

#include "pattern_extractor.hpp"

#include <string_view>
#include <utility>
#include <vector>

#include <catch2/catch_test_macros.hpp>

#include <silkworm/core/common/util.hpp>

namespace silkworm::snapshots::seg {

TEST_CASE("PatternExtractor1") {
    Superstring superstring{from_hex("0x0000016c016f016e016700000177016f01720164000001300120016c016f016e0167016c016f016e01670177016f017201640120013000000000016c016f016e016700000177016f01720164000001310120016c016f016e0167016c016f016e01670177016f017201640120013100000000016c016f016e016700000177016f01720164000001320120016c016f016e0167016c016f016e01670177016f017201640120013200000000016c016f016e016700000177016f01720164000001330120016c016f016e0167016c016f016e01670177016f017201640120013300000000016c016f016e016700000177016f01720164000001340120016c016f016e0167016c016f016e01670177016f017201640120013400000000016c016f016e016700000177016f01720164000001350120016c016f016e0167016c016f016e01670177016f017201640120013500000000016c016f016e016700000177016f01720164000001360120016c016f016e0167016c016f016e01670177016f017201640120013600000000016c016f016e016700000177016f01720164000001370120016c016f016e0167016c016f016e01670177016f017201640120013700000000016c016f016e016700000177016f01720164000001380120016c016f016e0167016c016f016e01670177016f017201640120013800000000016c016f016e016700000177016f01720164000001390120016c016f016e0167016c016f016e01670177016f017201640120013900000000016c016f016e016700000177016f017201640000013101300120016c016f016e0167016c016f016e01670177016f0172016401200131013000000000016c016f016e016700000177016f017201640000013101310120016c016f016e0167016c016f016e01670177016f0172016401200131013100000000016c016f016e016700000177016f017201640000013101320120016c016f016e0167016c016f016e01670177016f0172016401200131013200000000016c016f016e016700000177016f017201640000013101330120016c016f016e0167016c016f016e01670177016f0172016401200131013300000000016c016f016e016700000177016f017201640000013101340120016c016f016e0167016c016f016e01670177016f0172016401200131013400000000016c016f016e016700000177016f017201640000013101350120016c016f016e0167016c016f016e01670177016f0172016401200131013500000000016c016f016e016700000177016f017201640000013101360120016c016f016e0167016c016f016e01670177016f0172016401200131013600000000016c016f016e016700000177016f017201640000013101370120016c016f016e0167016c016f016e01670177016f0172016401200131013700000000016c016f016e016700000177016f017201640000013101380120016c016f016e0167016c016f016e01670177016f0172016401200131013800000000016c016f016e016700000177016f017201640000013101390120016c016f016e0167016c016f016e01670177016f0172016401200131013900000000016c016f016e016700000177016f017201640000013201300120016c016f016e0167016c016f016e01670177016f0172016401200132013000000000016c016f016e016700000177016f017201640000013201310120016c016f016e0167016c016f016e01670177016f0172016401200132013100000000016c016f016e016700000177016f017201640000013201320120016c016f016e0167016c016f016e01670177016f0172016401200132013200000000016c016f016e016700000177016f017201640000013201330120016c016f016e0167016c016f016e01670177016f0172016401200132013300000000016c016f016e016700000177016f017201640000013201340120016c016f016e0167016c016f016e01670177016f0172016401200132013400000000016c016f016e016700000177016f017201640000013201350120016c016f016e0167016c016f016e01670177016f0172016401200132013500000000016c016f016e016700000177016f017201640000013201360120016c016f016e0167016c016f016e01670177016f0172016401200132013600000000016c016f016e016700000177016f017201640000013201370120016c016f016e0167016c016f016e01670177016f0172016401200132013700000000016c016f016e016700000177016f017201640000013201380120016c016f016e0167016c016f016e01670177016f0172016401200132013800000000016c016f016e016700000177016f017201640000013201390120016c016f016e0167016c016f016e01670177016f0172016401200132013900000000016c016f016e016700000177016f017201640000013301300120016c016f016e0167016c016f016e01670177016f0172016401200133013000000000016c016f016e016700000177016f017201640000013301310120016c016f016e0167016c016f016e01670177016f0172016401200133013100000000016c016f016e016700000177016f017201640000013301320120016c016f016e0167016c016f016e01670177016f0172016401200133013200000000016c016f016e016700000177016f017201640000013301330120016c016f016e0167016c016f016e01670177016f0172016401200133013300000000016c016f016e016700000177016f017201640000013301340120016c016f016e0167016c016f016e01670177016f0172016401200133013400000000016c016f016e016700000177016f017201640000013301350120016c016f016e0167016c016f016e01670177016f0172016401200133013500000000016c016f016e016700000177016f017201640000013301360120016c016f016e0167016c016f016e01670177016f0172016401200133013600000000016c016f016e016700000177016f017201640000013301370120016c016f016e0167016c016f016e01670177016f0172016401200133013700000000016c016f016e016700000177016f017201640000013301380120016c016f016e0167016c016f016e01670177016f0172016401200133013800000000016c016f016e016700000177016f017201640000013301390120016c016f016e0167016c016f016e01670177016f0172016401200133013900000000016c016f016e016700000177016f017201640000013401300120016c016f016e0167016c016f016e01670177016f0172016401200134013000000000016c016f016e016700000177016f017201640000013401310120016c016f016e0167016c016f016e01670177016f0172016401200134013100000000016c016f016e016700000177016f017201640000013401320120016c016f016e0167016c016f016e01670177016f0172016401200134013200000000016c016f016e016700000177016f017201640000013401330120016c016f016e0167016c016f016e01670177016f0172016401200134013300000000016c016f016e016700000177016f017201640000013401340120016c016f016e0167016c016f016e01670177016f0172016401200134013400000000016c016f016e016700000177016f017201640000013401350120016c016f016e0167016c016f016e01670177016f0172016401200134013500000000016c016f016e016700000177016f017201640000013401360120016c016f016e0167016c016f016e01670177016f0172016401200134013600000000016c016f016e016700000177016f017201640000013401370120016c016f016e0167016c016f016e01670177016f0172016401200134013700000000016c016f016e016700000177016f017201640000013401380120016c016f016e0167016c016f016e01670177016f0172016401200134013800000000016c016f016e016700000177016f017201640000013401390120016c016f016e0167016c016f016e01670177016f0172016401200134013900000000016c016f016e016700000177016f017201640000013501300120016c016f016e0167016c016f016e01670177016f0172016401200135013000000000016c016f016e016700000177016f017201640000013501310120016c016f016e0167016c016f016e01670177016f0172016401200135013100000000016c016f016e016700000177016f017201640000013501320120016c016f016e0167016c016f016e01670177016f0172016401200135013200000000016c016f016e016700000177016f017201640000013501330120016c016f016e0167016c016f016e01670177016f0172016401200135013300000000016c016f016e016700000177016f017201640000013501340120016c016f016e0167016c016f016e01670177016f0172016401200135013400000000016c016f016e016700000177016f017201640000013501350120016c016f016e0167016c016f016e01670177016f0172016401200135013500000000016c016f016e016700000177016f017201640000013501360120016c016f016e0167016c016f016e01670177016f0172016401200135013600000000016c016f016e016700000177016f017201640000013501370120016c016f016e0167016c016f016e01670177016f0172016401200135013700000000016c016f016e016700000177016f017201640000013501380120016c016f016e0167016c016f016e01670177016f0172016401200135013800000000016c016f016e016700000177016f017201640000013501390120016c016f016e0167016c016f016e01670177016f0172016401200135013900000000016c016f016e016700000177016f017201640000013601300120016c016f016e0167016c016f016e01670177016f0172016401200136013000000000016c016f016e016700000177016f017201640000013601310120016c016f016e0167016c016f016e01670177016f0172016401200136013100000000016c016f016e016700000177016f017201640000013601320120016c016f016e0167016c016f016e01670177016f0172016401200136013200000000016c016f016e016700000177016f017201640000013601330120016c016f016e0167016c016f016e01670177016f0172016401200136013300000000016c016f016e016700000177016f017201640000013601340120016c016f016e0167016c016f016e01670177016f0172016401200136013400000000016c016f016e016700000177016f017201640000013601350120016c016f016e0167016c016f016e01670177016f0172016401200136013500000000016c016f016e016700000177016f017201640000013601360120016c016f016e0167016c016f016e01670177016f0172016401200136013600000000016c016f016e016700000177016f017201640000013601370120016c016f016e0167016c016f016e01670177016f0172016401200136013700000000016c016f016e016700000177016f017201640000013601380120016c016f016e0167016c016f016e01670177016f0172016401200136013800000000016c016f016e016700000177016f017201640000013601390120016c016f016e0167016c016f016e01670177016f0172016401200136013900000000016c016f016e016700000177016f017201640000013701300120016c016f016e0167016c016f016e01670177016f0172016401200137013000000000016c016f016e016700000177016f017201640000013701310120016c016f016e0167016c016f016e01670177016f0172016401200137013100000000016c016f016e016700000177016f017201640000013701320120016c016f016e0167016c016f016e01670177016f0172016401200137013200000000016c016f016e016700000177016f017201640000013701330120016c016f016e0167016c016f016e01670177016f0172016401200137013300000000016c016f016e016700000177016f017201640000013701340120016c016f016e0167016c016f016e01670177016f0172016401200137013400000000016c016f016e016700000177016f017201640000013701350120016c016f016e0167016c016f016e01670177016f0172016401200137013500000000016c016f016e016700000177016f017201640000013701360120016c016f016e0167016c016f016e01670177016f0172016401200137013600000000016c016f016e016700000177016f017201640000013701370120016c016f016e0167016c016f016e01670177016f0172016401200137013700000000016c016f016e016700000177016f017201640000013701380120016c016f016e0167016c016f016e01670177016f0172016401200137013800000000016c016f016e016700000177016f017201640000013701390120016c016f016e0167016c016f016e01670177016f0172016401200137013900000000016c016f016e016700000177016f017201640000013801300120016c016f016e0167016c016f016e01670177016f0172016401200138013000000000016c016f016e016700000177016f017201640000013801310120016c016f016e0167016c016f016e01670177016f0172016401200138013100000000016c016f016e016700000177016f017201640000013801320120016c016f016e0167016c016f016e01670177016f0172016401200138013200000000016c016f016e016700000177016f017201640000013801330120016c016f016e0167016c016f016e01670177016f0172016401200138013300000000016c016f016e016700000177016f017201640000013801340120016c016f016e0167016c016f016e01670177016f0172016401200138013400000000016c016f016e016700000177016f017201640000013801350120016c016f016e0167016c016f016e01670177016f0172016401200138013500000000016c016f016e016700000177016f017201640000013801360120016c016f016e0167016c016f016e01670177016f0172016401200138013600000000016c016f016e016700000177016f017201640000013801370120016c016f016e0167016c016f016e01670177016f0172016401200138013700000000016c016f016e016700000177016f017201640000013801380120016c016f016e0167016c016f016e01670177016f0172016401200138013800000000016c016f016e016700000177016f017201640000013801390120016c016f016e0167016c016f016e01670177016f0172016401200138013900000000016c016f016e016700000177016f017201640000013901300120016c016f016e0167016c016f016e01670177016f0172016401200139013000000000016c016f016e016700000177016f017201640000013901310120016c016f016e0167016c016f016e01670177016f0172016401200139013100000000016c016f016e016700000177016f017201640000013901320120016c016f016e0167016c016f016e01670177016f0172016401200139013200000000016c016f016e016700000177016f017201640000013901330120016c016f016e0167016c016f016e01670177016f0172016401200139013300000000016c016f016e016700000177016f017201640000013901340120016c016f016e0167016c016f016e01670177016f0172016401200139013400000000016c016f016e016700000177016f017201640000013901350120016c016f016e0167016c016f016e01670177016f0172016401200139013500000000016c016f016e016700000177016f017201640000013901360120016c016f016e0167016c016f016e01670177016f0172016401200139013600000000016c016f016e016700000177016f017201640000013901370120016c016f016e0167016c016f016e01670177016f0172016401200139013700000000016c016f016e016700000177016f017201640000013901380120016c016f016e0167016c016f016e01670177016f0172016401200139013800000000016c016f016e016700000177016f017201640000013901390120016c016f016e0167016c016f016e01670177016f017201640120013901390000").value()};

    // hex pattern & score
    std::vector<std::pair<std::string_view, uint64_t>> expected_patterns{
        {"0x206c6f6e676c6f6e67776f72642031", 165},
        {"0x206c6f6e676c6f6e67776f72642032", 165},
        {"0x206c6f6e676c6f6e67776f72642033", 165},
        {"0x206c6f6e676c6f6e67776f72642034", 165},
        {"0x206c6f6e676c6f6e67776f72642035", 165},
        {"0x206c6f6e676c6f6e67776f72642036", 165},
        {"0x206c6f6e676c6f6e67776f72642037", 165},
        {"0x206c6f6e676c6f6e67776f72642038", 165},
        {"0x206c6f6e676c6f6e67776f72642039", 165},
        {"0x30206c6f6e676c6f6e67776f726420", 150},
        {"0x31206c6f6e676c6f6e67776f726420", 150},
        {"0x32206c6f6e676c6f6e67776f726420", 150},
        {"0x33206c6f6e676c6f6e67776f726420", 150},
        {"0x34206c6f6e676c6f6e67776f726420", 150},
        {"0x35206c6f6e676c6f6e67776f726420", 150},
        {"0x36206c6f6e676c6f6e67776f726420", 150},
        {"0x37206c6f6e676c6f6e67776f726420", 150},
        {"0x38206c6f6e676c6f6e67776f726420", 150},
        {"0x676c6f6e67776f72642031", 121},
        {"0x676c6f6e67776f72642032", 121},
        {"0x676c6f6e67776f72642033", 121},
        {"0x676c6f6e67776f72642034", 121},
        {"0x676c6f6e67776f72642035", 121},
        {"0x676c6f6e67776f72642036", 121},
        {"0x676c6f6e67776f72642037", 121},
        {"0x676c6f6e67776f72642038", 121},
        {"0x676c6f6e67776f72642039", 121},
        {"0x67776f72642031", 77},
        {"0x67776f72642032", 77},
        {"0x67776f72642033", 77},
        {"0x67776f72642034", 77},
        {"0x67776f72642035", 77},
        {"0x67776f72642036", 77},
        {"0x67776f72642037", 77},
        {"0x67776f72642038", 77},
        {"0x67776f72642039", 77},
        {"0x6c6f6e676c6f6e67776f72642031", 154},
        {"0x6c6f6e676c6f6e67776f72642032", 154},
        {"0x6c6f6e676c6f6e67776f72642033", 154},
        {"0x6c6f6e676c6f6e67776f72642034", 154},
        {"0x6c6f6e676c6f6e67776f72642035", 154},
        {"0x6c6f6e676c6f6e67776f72642036", 154},
        {"0x6c6f6e676c6f6e67776f72642037", 154},
        {"0x6c6f6e676c6f6e67776f72642038", 154},
        {"0x6c6f6e676c6f6e67776f72642039", 154},
        {"0x6c6f6e67776f72642031", 110},
        {"0x6c6f6e67776f72642032", 110},
        {"0x6c6f6e67776f72642033", 110},
        {"0x6c6f6e67776f72642034", 110},
        {"0x6c6f6e67776f72642035", 110},
        {"0x6c6f6e67776f72642036", 110},
        {"0x6c6f6e67776f72642037", 110},
        {"0x6c6f6e67776f72642038", 110},
        {"0x6c6f6e67776f72642039", 110},
        {"0x6e676c6f6e67776f72642031", 132},
        {"0x6e676c6f6e67776f72642032", 132},
        {"0x6e676c6f6e67776f72642033", 132},
        {"0x6e676c6f6e67776f72642034", 132},
        {"0x6e676c6f6e67776f72642035", 132},
        {"0x6e676c6f6e67776f72642036", 132},
        {"0x6e676c6f6e67776f72642037", 132},
        {"0x6e676c6f6e67776f72642038", 132},
        {"0x6e676c6f6e67776f72642039", 132},
        {"0x6e67776f72642031", 88},
        {"0x6e67776f72642032", 88},
        {"0x6e67776f72642033", 88},
        {"0x6e67776f72642034", 88},
        {"0x6e67776f72642035", 88},
        {"0x6e67776f72642036", 88},
        {"0x6e67776f72642037", 88},
        {"0x6e67776f72642038", 88},
        {"0x6e67776f72642039", 88},
        {"0x6f6e676c6f6e67776f72642031", 143},
        {"0x6f6e676c6f6e67776f72642032", 143},
        {"0x6f6e676c6f6e67776f72642033", 143},
        {"0x6f6e676c6f6e67776f72642034", 143},
        {"0x6f6e676c6f6e67776f72642035", 143},
        {"0x6f6e676c6f6e67776f72642036", 143},
        {"0x6f6e676c6f6e67776f72642037", 143},
        {"0x6f6e676c6f6e67776f72642038", 143},
        {"0x6f6e676c6f6e67776f72642039", 143},
        {"0x6f6e67776f72642031", 99},
        {"0x6f6e67776f72642032", 99},
        {"0x6f6e67776f72642033", 99},
        {"0x6f6e67776f72642034", 99},
        {"0x6f6e67776f72642035", 99},
        {"0x6f6e67776f72642036", 99},
        {"0x6f6e67776f72642037", 99},
        {"0x6f6e67776f72642038", 99},
        {"0x6f6e67776f72642039", 99},
        {"0x6f72642031", 55},
        {"0x6f72642032", 55},
        {"0x6f72642033", 55},
        {"0x6f72642034", 55},
        {"0x6f72642035", 55},
        {"0x6f72642036", 55},
        {"0x6f72642037", 55},
        {"0x6f72642038", 55},
        {"0x6f72642039", 55},
        {"0x776f72642031", 66},
        {"0x776f72642032", 66},
        {"0x776f72642033", 66},
        {"0x776f72642034", 66},
        {"0x776f72642035", 66},
        {"0x776f72642036", 66},
        {"0x776f72642037", 66},
        {"0x776f72642038", 66},
        {"0x776f72642039", 66},
    };

    PatternExtractor extractor(1);
    size_t i = 0;
    extractor.extract_patterns(superstring, [&](ByteView pattern, uint64_t score) -> void {
        REQUIRE(i < expected_patterns.size());
        CHECK(pattern == from_hex(expected_patterns[i].first));
        CHECK(score == expected_patterns[i].second);
        ++i;
    });
    CHECK(i == expected_patterns.size());
}

}  // namespace silkworm::snapshots::seg
